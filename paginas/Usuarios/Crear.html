<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agregar Usuario</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;600&display=swap" rel="stylesheet" />
  <link href="/css/site.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-dark text-light">
<script>
    document.addEventListener("DOMContentLoaded", () => {
      const isAdmin = localStorage.getItem("isAdmin");
      if (isAdmin !== "true") {
        window.location.href = "/Index.html";
      }
    });
  </script>
  <!-- Header -->
  <div id="header-placeholder"></div>

  <div class="container mt-5">
    <div class="text-center mb-4">
      <h1 class="fw-bold text-warning">
        <i class="bi bi-person-plus-fill"></i> Agregar Nuevo Usuario
      </h1>
      <p class="text-warning">Complete los datos para registrar un nuevo cliente</p>
    </div>

    <div class="card shadow p-4 rounded dark-container mx-auto" style="max-width:700px;">
      <form id="crearUsuarioForm" method="post" action="/paginas/Usuarios/Crear.html" novalidate>
        <div class="mb-3">
          <label class="form-label fw-bold text-warning">Cédula / RUC</label>
          <input type="text" name="UsuCiRuc" class="form-control bg-dark text-light border-warning" required maxlength="13" />
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold text-warning">Nombre Completo</label>
          <input type="text" name="UsuNombre" class="form-control bg-dark text-light border-warning" required />
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold text-warning">Email</label>
          <input type="email" name="UsuEmail" class="form-control bg-dark text-light border-warning" required />
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold text-warning">Teléfono</label>
          <input type="text" name="UsuTelefono" class="form-control bg-dark text-light border-warning" required maxlength="15" />
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold text-warning">Dirección</label>
          <input type="text" name="UsuDireccion" class="form-control bg-dark text-light border-warning" required />
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold text-warning">Ciudad</label>
          <select name="UsuCiudad" id="UsuCiudad" class="form-select bg-dark text-light border-warning" required>
            <option value="">Seleccione una ciudad</option>
            <option value="Guayaquil">Guayaquil</option>
            <option value="Quito">Quito</option>
            <option value="Cuenca">Cuenca</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold text-warning">Sector de Entrega</label>
          <select name="UsuSectorEntrega" id="UsuSectorEntrega" class="form-select bg-dark text-light border-warning" required>
            <option value="">Seleccione un sector</option>
          </select>
        </div>

        <div class="mb-4">
          <label class="form-label fw-bold text-warning">Género</label>
          <select name="UsuGenero" class="form-select bg-dark text-light border-warning" required>
            <option value="">Seleccione</option>
            <option>Masculino</option>
            <option>Femenino</option>
            <option>Otro</option>
          </select>
        </div>

        <div class="d-flex justify-content-between">
          <button type="submit" class="btn btn-warning fw-bold">
            <i class="bi bi-save-fill"></i> Guardar
          </button>
          <a href="../Usuarios/Index.html" class="btn btn-outline-warning fw-bold">
            <i class="bi bi-arrow-left-circle"></i> Cancelar
          </a>
        </div>
      </form>
    </div>
  </div>

  <!-- Footer -->
  <div id="footer-placeholder" class="mt-5"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Cargar header y footer con fetch
  fetch("../Shared/Header.html")
    .then(res => res.text())
    .then(html => document.getElementById("header-placeholder").innerHTML = html);
  fetch("../Shared/Footer.html")
    .then(res => res.text())
    .then(html => document.getElementById("footer-placeholder").innerHTML = html);

  // Manejar cambio de ciudad y llenar sectores
  const selectCiudad = document.getElementById("UsuCiudad");
  const selectSector = document.getElementById("UsuSectorEntrega");

  selectCiudad.addEventListener("change", () => {
    const ciudad = selectCiudad.value;
    let sectores = [];

    if (ciudad === 'Guayaquil') {
      sectores = ['Saucillo', 'Urdesa', 'Centro', 'Alborada'];
    } else if (ciudad === 'Quito') {
      sectores = ['Carapungo', 'Valle de los Chillos', 'Cumbayá', 'La Floresta'];
    } else if (ciudad === 'Cuenca') {
      sectores = ['Centro Histórico', 'Choloma', 'El Valle', 'Baños'];
    }

    // Limpiar opciones y agregar placeholder
    selectSector.innerHTML = '<option value="">Seleccione un sector</option>';
    sectores.forEach(sector => {
      const option = document.createElement("option");
      option.value = sector;
      option.textContent = sector;
      selectSector.appendChild(option);
    });
  });

  // Manejar submit del formulario
  const form = document.getElementById("crearUsuarioForm");
  form.addEventListener("submit", async (event) => {
    event.preventDefault(); // evitar envío normal

    // Obtener valores
    const ciRuc = form.querySelector('input[name="UsuCiRuc"]').value.trim();
    const nombre = form.querySelector('input[name="UsuNombre"]').value.trim();
    const email = form.querySelector('input[name="UsuEmail"]').value.trim();
    const telefono = form.querySelector('input[name="UsuTelefono"]').value.trim();
    const direccion = form.querySelector('input[name="UsuDireccion"]').value.trim();
    const ciudad = form.querySelector('select[name="UsuCiudad"]').value;
    const sector = form.querySelector('select[name="UsuSectorEntrega"]').value;
    const genero = form.querySelector('select[name="UsuGenero"]').value;

    // Validaciones simples
    if (ciRuc.length < 10 || ciRuc.length > 13) {
      alert("⚠️ La cédula o RUC debe tener entre 10 y 13 caracteres.");
      return;
    }
    if (telefono.length < 10) {
      alert("⚠️ El teléfono debe tener al menos 10 caracteres.");
      return;
    }
    if (!nombre || !email || !direccion || !ciudad || !sector || !genero) {
      alert("⚠️ Por favor complete todos los campos.");
      return;
    }

    // Construir objeto DTO
    const usuarioDTO = {
      USU_CI_RUC: ciRuc,
      USU_NOMBRE: nombre,
      USU_EMAIL: email,
      USU_TELEFONO: telefono,
      USU_DIRECCION: direccion,
      USU_CIUDAD: ciudad,
      USU_SECTOR_ENTREGA: sector,
      USU_GENERO: genero,
      USU_FECHA_REGISTRO: new Date().toISOString(),
      USU_ESTADO: "ACT" // o según tu lógica
    };

    try {
      const response = await fetch('https://eltragolocorest.runasp.net/api/Usuario', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(usuarioDTO)
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(errorText || 'Error al crear el usuario');
      }

      alert("✅ Usuario creado correctamente.");
      form.reset();

    } catch (error) {
      alert("❌ " + error.message);
    }
  });
});
</script>

</body>
</html>
